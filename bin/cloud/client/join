#!/bin/bash

JQBIN="/opt/clusterware/opt/jq/bin/jq"
_TRIGGER=/opt/clusterware/libexec/share/flight-trigger
DIRECTORY=$1
TRIGGERPASSWORD=$2

if [ -z $DIRECTORY ];
then
    DIRECTORY="10.75.0.254"
fi

if [ -z $TRIGGERPASSWORD ];
then
    TRIGGERPASSWORD="password"
    export cw_FLIGHT_TRIGGER_auth=alces:$TRIGGERPASSWORD
fi

CLIENTNAME=`hostname -s`
CLIENTIP=`hostname -i`
DOMAIN=$(hostname -d | grep -o "\." | wc -l)
if [ "$DOMAIN" == "2" ];
then
  DOMAIN=$(hostname -d)
elif [ "$DOMAIN" == "3" ];
then
  DOMAIN=$(hostname -d | cut -d . -f 2-4)
  CLUSTER=$(hostname -d | cut -d . -f 1)
fi
DIRECTORYFQDN="directory.$DOMAIN"
REALM=$(echo $DOMAIN | sed -e 's/\(.*\)/\U\1/')
ONETIMEPASS=$(openssl rand -hex 6)

function add {


    ADD=$($_TRIGGER https://$DIRECTORY:8444/trigger/add $CLIENTNAME $CLIENTIP $ONETIMEPASS $CLUSTER |
    $JQBIN '.responses[].result' |
    tr -d '"' | cut -c -2)

    if [ "$ADD" == "OK" ];
    then
        echo "Node successfully added to domain"

        enrol_ipa

    elif [ "$ADD" == "FAIL - ENTRY EXISTS" ];
    then
        echo "Unable to add node: $CLIENTNAME"
        exit 0
    fi

}

function enrol_ipa {

    # Prepare /etc/hosts
    sed -i -e "/.*127.0.0.1 $CLIENTNAME.*/d" \
           -e "/.*::1 $CLIENTNAME.*/d" \
           /etc/hosts

    # Stop DHCP changing /etc/resolv.conf on reboot
    sed -i -e "s/^PEERDNS.*$/PEERDNS=\"no\"/g" \
        /etc/sysconfig/network-scripts/ifcfg-eth0

    # Prepare /etc/resolv.conf
    if [ -z $CLUSTER ];
    then
      echo -e "search $DOMAIN\nnameserver $DIRECTORY" > /etc/resolv.conf
    else
      echo -e "search $CLUSTER.$DOMAIN $DOMAIN\nnameserver $DIRECTORY" > /etc/resolv.conf
    fi

    # Install required packages
    yum -y -e0 install ipa-client ipa-admintools

    # Sign up to IPA


    ipa-client-install \
        --no-ntp \
        --mkhomedir \
        --force-join \
        --realm="$REALM" \
        --server="${DIRECTORYFQDN}" \
        -w "$ONETIMEPASS" \
        --domain="`hostname -d`" \
        --unattended

}

add
