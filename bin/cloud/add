#!/bin/bash

keytab=/opt/symphony-directory/etc/hadder.keytab
keyuser=hadder

clientname=$1
clientip=$2
onetimepass=$3
cluster=$4
directoryappliance=`hostname -f`
domain=`hostname -d`
realm=$(echo $domain | sed -e 's/\(.*\)/\U\1/')

check_cluster() {

  if [ -z $cluster ];
  then
    check_node
  else
  if [ ! "$(ipa dnszone-find | grep "${cluster}.${domain}." | awk '{print $3}')" == "${cluster}.${domain}." ];
  then
    if [ ! -z $cluster ];
    then
        ipa dnszone-add $cluster.$domain --name-server $directoryappliance. >> /dev/null 2>&1
        ipa dnsrecord-add $domain $cluster --ns-rec=$directoryappliance. >> /dev/null 2>&1
    fi
  fi
  fi

}

cluster_hostgroup() {

  if [ -z $cluster ]; then
    if [ ! "$(ipa hostgroup-find | grep "Host-group" | grep "${domain}")" ]; then
      ipa hostgroup-add ${domain} \
          --desc "Host group for ${domain} infrastructure hosts"
    fi
  elif [ ! -z $cluster ]; then
    if [ ! "$(ipa hostgroup-find | grep "Host-group" | grep "${cluster}")" ]; then
      ipa hostgroup-add ${cluster}.${domain} \
          --desc "Host group for ${cluster} cluster hosts"
    fi
  fi

}

check_node() {

  zonefile="/opt/symphony-directory/etc/zones"
  ipa dnszone-find |
      grep "Zone\ name:" |
      grep -v "${cluster}.${domain}" |
      awk '{print $3}' > $zonefile
  while read -r dns_zone; do
    if [ "$(ipa dnsrecord-find $dns_zone | grep $clientip)" ]; then
      domainrecords=$(ipa dnsrecord-find $dns_zone $clientname |
                          grep "${clientname}" |
                          awk '{print $3}')
      if [ "${domainrecords}" == "${clientname}" ]; then
        ipa host-del $clientname.$dns_zone \
            --update-dns --continue \
            >> /dev/null 2>&1
      fi
    fi
  done < "$zonefile"
  echo "OK"
  cluster_hostgroup >> /dev/null 2>&1
  add_node >> /dev/null 2>&1

}

add_node() {

    if [ -z $cluster ];
    then
        ipa host-add $clientname.$domain --ip-address=$clientip
        ipa host-mod $clientname.$domain --password="${onetimepass}"
        ipa hostgroup-add-member ${domain} --hosts $clientname.$domain
        ipa hostgroup-add-member usernodes --hosts $clientname.$domain
    elif [ ! -z $cluster ];
    then
        ipa host-add $clientname.$cluster.$domain --ip-address=$clientip
        ipa host-mod $clientname.$cluster.$domain --password="${onetimepass}"
        ipa hostgroup-add-member ${cluster} --hosts $clientname.$cluster.$domain
        ipa hostgroup-add-member usernodes --hosts $clientname.$cluster.$domain
    fi
    echo "OK"

}

if [[ -z $clientname || -z $clientip || -z $onetimepass ]];
then

  echo "One or more parameters not provided"
  echo "Usage: $0 <client name> <client ip> <cluster (optional)> <one time password>"

else

  kinit -kt $keytab $keyuser
  check_cluster
  check_node

fi
